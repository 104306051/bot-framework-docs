---
title: Request payment | Microsoft Docs
description: Learn how to send a payment request using the Bot Builder SDK for Node.js.
author: kbrandl
ms.author: v-kibran
manager: rstand
ms.topic: article
ms.prod: bot-framework
ms.date: 
ms.reviewer: 
---

# Request payment
> [!div class="op_single_selector"]
> - [.NET](../dotnet/bot-builder-dotnet-request-payment.md)
> - [Node.js](../nodejs/bot-builder-nodejs-request-payment.md)

If your bot enables users to purchase items, it can request payment by including 
a special type of button within a [rich card](~/nodejs/bot-builder-nodejs-send-rich-cards.md). 
This article describes how to send a payment request using the Bot Builder SDK for Node.js.

## Prerequisites

Before you can send a payment request using the Bot Builder SDK for Node.js, you must complete these prerequisite tasks.

### Register and configure your bot

1. [Register](~/portal-register-bot.md) your bot with the Bot Framework.

2. Set the `MICROSOFT_APP_ID` and `MICROSOFT_APP_PASSWORD` environment variables to the app ID and password values that were generated for your bot during the registration process. 

### Create and configure merchant account

1. <a href="https://dashboard.stripe.com/register" target="_blank">Create and activate a Stripe account.</a>

2. <a href="https://seller.microsoft.com/en-us/dashboard/registration/seller/?accountprogram=skypebots&setvar=fltsellerregistration:1" target="_blank">Sign in to Seller Center with your Microsoft account.</a>

3. Within Seller Center, connect your account with Stripe.

4. Within Seller Center, navigate to the Dashboard and copy the value of **MerchantID**.

5. Update the `PAYMENTS_MERCHANT_ID` environment variable to the value that you copied from the Seller Center Dashboard. 

[!include[Payment process overview](~/includes/snippet-payment-process-overview.md)]

## Payments Bot sample

The <a href="https://fuselabs.visualstudio.com/_git/PaymentSample?path=%2Fnode&version=GBmaster&_a=contents" target="_blank">Payments Bot</a> sample provides a example of a bot that sends a payment request 
by using Node.js. 
To see this sample bot in action, you can 
<a href="https://webchat.botframework.com/embed/paymentsample?s=d39Bk7JOMzQ.cwA.Rig.dumLki9bs3uqfWFMjXPn5PFnQVmT2VAVR1Zl1iPi07k" target="_blank">try it out in web chat</a> or
<a href="https://join.skype.com/bot/9fbc0f17-43eb-40fe-bf3b-af151e6ce45e" target="_blank">add it as a Skype 
contact</a>. 

> [!NOTE]
> To complete the end-to-end payment process using the **Payments Bot** sample in web chat or Skype, 
> you must specify a valid credit card or debit card within your Microsoft account or via guest checkout 
> (i.e., a real card that has been issued by a U.S. bank). 
> Your card will not be charged and the card's CVV will not be verified, 
> because the **Payments Bot** sample runs in test mode (i.e., `PAYMENTS_LIVEMODE` is set to `false` in **.env**).

The next few sections of this article describe the three parts of the payment process, 
in the context of the **Payments Bot** sample.

##<a id="request-payment"></a> Requesting payment

Your bot can request payment from a user by sending a message that contains a 
[rich card](~/nodejs/bot-builder-nodejs-send-rich-cards.md) with a button that specifies 
`type` of "payment". 
This code snippet from the **Payments Bot** sample creates a message that contains a Hero card with a **Buy** button that the user can click (or tap) to initiate the payment process. 

[!code-javascript[Request payment](~/includes/code/node-request-payment.js#requestPayment)]

In this example, the button's type is specified as `payments.PaymentActionType`, which 
the app defines as "payment". 
The button's value is populated by the `createPaymentRequest` function, which returns 
a `PaymentRequest` object that contains information about payment details, valid payment methods, 
and valid payment options. 
For more information about implementation details, see **app.js** within the 
<a href="https://fuselabs.visualstudio.com/_git/PaymentSample?path=%2Fnode&version=GBmaster&_a=contents" target="_blank">Payments Bot</a> sample.

This screenshot shows the Hero card (with **Buy** button) that's generated by the code snippet above. 
 
![Payments sample bot](~/media/payments-bot-buy.png) 

> [!IMPORTANT]
> Any user that has access to the **Buy** button may use it to initiate the payment process. 
> Within the context of a group conversation, it is not possible to designate a button for use by only 
> a specific user. 

##<a id="user-experience"></a> User experience

When a user clicks the **Buy** button, he or she is directed to the payment web experience to provide all required payment, shipping, and contact information. 

![Microsoft payment](~/media/microsoft-payment.png)

### HTTP callbacks

HTTP callbacks will be sent to your bot to indicate that it should perform certain operations. 
Each callback will be an event that contains these property values: 

| Property | Value |
|----|----|
| `type` | invoke | 
| `name` | Indicates the type of operation that the bot should perform (e.g., update shipping address, update shipping option, complete payment). | 
| `value` | The request payload in JSON format. | 
| `relatesTo` |  Describes the channel and user that are associated with the payment request. | 

> [!NOTE]
> `invoke` is a special event type that is reserved for use by the Microsoft Bot Framework. 
> The sender of an `invoke` event will expect your bot to acknowledge the callback by sending an HTTP response.

##<a id="process-callbacks"></a> Processing callbacks

[!include[Process callbacks overview](~/includes/snippet-payment-process-callbacks-overview.md)]

### Update Shipping Address and Update Shipping Option callbacks

[!include[Process shipping address and shipping option callbacks](~/includes/snippet-payment-process-callbacks-1.md)]

### Payment Complete callbacks

When your bot receives a Payment Complete callback, 
it should recalculate payment details to verify that the payment-related data specified in the callback 
(which represents the payment that the user agreed to in the payment web experience) is indeed valid. 
If there's a mismatch between the values that your bot expects and the values that it receives in the 
Payment Complete callback, your bot can cancel the payment by responding to the callback with any 
HTTP status code in the `400` or `500` range. 
In addition to verifying payment details, your bot should also verify that the order can be fulfilled, 
before it initiates payment processing. 
For example, it may want to verify that the item(s) being purchased are still available in stock. 

If your bot determines that the payment details in the callback are valid and that the order can be fulfilled, 
it can initiate payment processing by passing the payment token to the payment processor (Stripe). 
The payment token exists within the payload of the callback and represents 
the data that the payment processor requires to process the payment (including credit or debit card number
in encrypted format). 
The payment token that your bot receives can only be used once, by the merchant that requested it, and
must be submitted to Stripe (the only payment processor that the Bot Framework currently supports). 
When your bot receives notification from the payment processor regarding the outcome of the transaction, 
it should respond to the Payment Complete callback that it received. 
It may respond with HTTP status code `200 OK` if the transaction was successful, or if the transaction failed, 
it may respond with any HTTP status code in the `400` or `500` range to cancel the payment.

This code snippet from the **Payments Bot** sample processes the callbacks that the bot receives. 

[!code-javascript[Request payment](~/includes/code/node-request-payment.js#processCallback)]

In this example, the bot examines the `name` property of the incoming event to identify the type of 
operation it needs to perform, and then calls the appropriate method(s) to process the callback. 
For more information about implementation details, see **app.js** 
within the <a href="https://fuselabs.visualstudio.com/_git/PaymentSample?path=%2Fnode&version=GBmaster&_a=contents" target="_blank">Payments Bot</a> sample.

## Testing a payments bot

[!include[Test a payments bot](~/includes/snippet-payment-test-bot.md)]

In the <a href="https://fuselabs.visualstudio.com/_git/PaymentSample?path=%2Fnode&version=GBmaster&_a=contents" target="_blank">Payments Bot</a> sample, the `PAYMENTS_LIVEMODE` environment variable in **.env** determines whether Payment Complete callbacks will contain emulated payment tokens or real payment tokens. If `PAYMENTS_LIVEMODE` is set to `false`, a header is added to the bot's outbound payment request to indicate that the bot is in test mode, and 
the Payment Complete callback will contain an emulated payment token that cannot be charged. If `PAYMENTS_LIVEMODE` is set to `true`, the header which indicates that the bot is in test mode is omitted from the bot's outbound payment request, and the Payment Complete callback will contain a real payment token that the bot will submit to Stripe 
for payment processing. This will be a real transaction that results in charges to the specified payment instrument. 

## Additional resources

- <a href="https://fuselabs.visualstudio.com/_git/PaymentSample?path=%2Fnode&version=GBmaster&_a=contents" target="_blank">Payments Bot sample</a>
- [Add rich card attachments to messages](~/nodejs/bot-builder-nodejs-send-rich-cards.md)
- <a href="http://www.w3.org/Payments/" target="_blank">Web Payments at W3C</a> 
